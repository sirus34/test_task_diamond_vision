# Описание системы (Container / уровень)

## 1. Участники

- **Customer (клиент)** — человек/команда, которая через веб-интерфейс создаёт кампании, управляет аккаунтом и доменами.
    
- **Lead (подписчик/лид)** — получатель писем, которому приходят рассылки и от которого могут прийти ответы/бэунсы.
    

## 2. Основные контейнеры системы

### Single-Page Application (SPA) — фронт для клиентов

- React/Vue SPA, доставляемый веб-сервером.
    
- Интерфейс создания кампаний, онбординга доменов, просмотра отчётов и логов.
    
- Взаимодействует с API по HTTPS (JSON/REST или GraphQL).
    

### Web Application / HTTP Server

- Статический и серверный рендеринг SPA, проксирование запросов к API, аутентификация сессий/JWT.
    

### API Application (контейнер: FastAPI / Node)

- Основная бизнес-логика: CRUD для кампаний, управление пользователями/домена­ми, триггеры старта кампаин, экспорты/отчёты.
    
- Приём запросов от SPA и Admin UI; отправляет задачи в Scheduler/Orchestrator.
    
- Читает/пишет в БД по pg driver.
    

### Database (Postgres)

- Хранит аккаунты, кампании, шаблоны писем, статус отправок, события доставки, webhooks, логи.
    
- Резервное копирование, реплика/standby для отказоустойчивости.
    

### Orchestrator (hub для отправки)

- Управление отправкой. Получает задания от API/Scheduler и решает куда и как отправлять каждое письмо: выбирает SMTP воркера, применяет ротацию IP, учитывает лимиты, репутацию, warm-up, retries.
    
- Открывает соединения к Email Sender (через SMTP API/SMTP/TCP), следит за concurrency и rate limits.
    

### E-mail System / Email Sender

- Набор отправляющих точек: внешние провайдеры, собственные Postfix.
    
- Получает команды от Orchestrator и доставляет письма конечным SMTP серверам.
    
- Redis/Celery или RabbitMQ + воркеры для асинхронных задач: подготовка писем, попытки отправки, обработка ошибок, вебхуки.
    

### Inbound Processor / Mail ingestion (IMAP/Webhook)

- Обрабатывает входящие письма, bounces, жалобы и ответы: парсит, классифицирует и отправляет в API для обновления статусов/уведомлений.
    
- Может быть реализован как worker, подписанный на mailbox через IMAP или webhook.
    

### Admin UI / Ops Console

- Интерфейс для операторов: мониторинг очередей, управление IP-пулами, просмотр логов и playbooks.
    

## 3. Поток данных (краткая последовательность)

1. Клиент через SPA создаёт кампанию → API (HTTPS).
    
2. API сохраняет кампанию в Postgres и ставит задачи в Scheduler/Queue.
    
3. Scheduler разбивает кампанию на пачки/задания и кладёт их в очередь.
    
4. Orchestrator маршрутизует каждое соединение к выбранному Email Sender (SMTP/Provider) с учётом репутации и лимитов.
    
5. Email Sender доставляет письмо адресату (Lead).
    
6. Ответы/бэунсы приходят на входящие ящики → Inbound Processor → API → обновление статусов в БД → отчёты в SPA.
    

## 4. Протоколы и интеграции

- Внутри: HTTPS (API), Redis (очереди), SMTP/TCP (отправка), IMAP/POP3 или webhook (входящие).
    
- DNS API (Cloudflare/Route53) для автоматической настройки DKIM при добавлении доменов.
    

## 5. Масштабирование и отказоустойчивость

- **Горизонталь:** многократные реплики API, воркеров и оркестратора; автоскейл по queue_depth/CPU.
    
- **Состояние:** PostgreSQL — primary + replica; Redis — кластер/реплика;
    
- **Резервирование отправки:** multi-provider (SES, Mailgun) + собственные SMTP инстансы; Orchestrator переключает провайдеры при падении/плохой репутации.
    

## 6. Наблюдаемость и безопасность

- **Метрики:** send_rate, bounce_rate, complaint_rate, delivery_latency, queue_depth, worker_health.
    
- **Логи.**
    
- **Безопасность:** RBAC для UI, HTTPS, лимиты запросов API, аудит действий операторов.
    
- **Политики почты:** unsubscribe, отслеживание доставок.
    